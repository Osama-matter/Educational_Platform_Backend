@page
@model Educational_Platform_Front_End.Pages.Courses.IndexModel
@{
    ViewData["Title"] = "All Courses";
}

<div class="container pt-8 pb-8">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="heading-2 mb-2">Course Catalog</h1>
            <p class="text-muted">Discover courses to advance your career and skills</p>
        </div>
        <a asp-page="/Courses/Create" class="btn btn--primary">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <line x1="10" y1="4" x2="10" y2="16" />
                <line x1="4" y1="10" x2="16" y2="10" />
            </svg>
            Create Course
        </a>
    </header>

    <div class="flex justify-between items-center mb-6">
        <div class="search-bar" style="flex: 1;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="11" cy="11" r="7" />
                <path d="M21 21l-4.3-4.3" />
            </svg>
            <input type="text" placeholder="Search by skill, role, or outcome" aria-label="Search courses" />
        </div>
        <div class="flex items-center gap-4">
            <span class="filter-chip">@Model.Courses?.Count() results</span>
            <div class="view-toggle" role="group" aria-label="Toggle view">
                <button type="button" class="is-active" data-view="grid">Grid</button>
                <button type="button" data-view="list">List</button>
            </div>
        </div>
    </div>

    <div class="catalog">
        <aside class="filter-panel" aria-label="Course filters">
            <h3 class="heading-5 mb-4">Filter courses</h3>
            @* ... Filter groups stay the same ... *@
            <button class="btn btn--secondary btn--full" type="button">Reset filters</button>
        </aside>

        <section>
            @if (Model.Courses != null && Model.Courses.Any())
            {
                <div class="course-list" data-view="grid">
                    @foreach (var course in Model.Courses)
                    {
                        <article class="card course-card-item">
                            @* Video Container (Hidden by default) *@
                            <div class="video-preview-container" style="display: none; aspect-ratio: 16/9;">
                                <iframe class="youtube-preview" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
                            </div>

                            @* Fallback Image *@
                            <img src="@course.Image_URl"
                                 class="card__image course-thumbnail"
                                 alt="@course.Title"
                                 loading="lazy" />

                            <div class="card__body">
                                <h2 class="card__title">@course.Title</h2>
                                <p class="text-small text-muted mb-4 card-description">
                                    @course.Description
                                </p>

                                <div class="flex items-center gap-4 mb-4">
                                    @if (course.EstimatedDurationHours.HasValue)
                                    {
                                        <span class="badge badge--neutral">@course.EstimatedDurationHours hours</span>
                                    }
                                    <span class="badge @(course.IsActive ? "badge--success" : "badge--neutral")">
                                        @(course.IsActive ? "Active" : "Inactive")
                                    </span>
                                </div>
                            </div>
                            <div class="card__footer">
                                <a asp-page="/Courses/Details" asp-route-id="@course.Id" class="btn btn--primary btn--full">
                                    View Course
                                </a>
                            </div>
                        </article>
                    }
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card__body text-center" style="padding: var(--spacing-16);">
                        <h2 class="heading-4 mb-2">No Courses Available</h2>
                        <a asp-page="/Courses/Create" class="btn btn--primary">Create First Course</a>
                    </div>
                </div>
            }
        </section>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. YouTube Detection Logic for Catalog
            const cards = document.querySelectorAll('.course-card-item');
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/i;

            cards.forEach(card => {
                const descElement = card.querySelector('.card-description');
                const thumbnail = card.querySelector('.course-thumbnail');
                const videoContainer = card.querySelector('.video-preview-container');
                const iframe = card.querySelector('.youtube-preview');

                if (descElement) {
                    const text = descElement.innerHTML;
                    const match = text.match(youtubeRegex);

                    if (match && match[1]) {
                        const videoId = match[1];

                        // Show Video, Hide Image
                        iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&showinfo=0`;
                        videoContainer.style.display = 'block';
                        thumbnail.style.display = 'none';

                        // Remove the link from the description text
                        const linkRegex = /(https?:\/\/(?:www\.)?(?:youtube\.com|youtu\.be)\/\S+)/gi;
                        descElement.innerHTML = text.replace(linkRegex, '').trim();
                    }
                }
            });

            // 2. View Toggle Logic
            const viewToggle = document.querySelectorAll('.view-toggle button');
            const courseList = document.querySelector('.course-list');

            viewToggle.forEach(button => {
                button.addEventListener('click', () => {
                    viewToggle.forEach(btn => btn.classList.remove('is-active'));
                    button.classList.add('is-active');
                    if (!courseList) return;
                    const view = button.dataset.view;
                    courseList.classList.toggle('course-list--row', view === 'list');
                });
            });
        });
    </script>
}