@page "{id:guid}"
@model Educational_Platform_Front_End.Pages.Courses.DetailsModel
@{
    ViewData["Title"] = Model.Course?.Title ?? "Course Details";
}

@if (Model.Course != null)
{
    <div class="container pt-8 pb-8">
        <div class="grid" style="grid-template-columns: minmax(0, 2fr) minmax(240px, 1fr); gap: var(--spacing-8);">
            <div>
                <div class="card" style="padding: var(--spacing-8);">
                    <p class="text-small text-muted">Course track</p>
                    <h1 class="heading-2">@Model.Course.Title</h1>
                    <p class="text-lead">@Model.Course.Description</p>
                    <div class="flex items-center gap-4 mb-4">
                        <span class="badge badge--primary">Instructor-led</span>
                        <span class="badge badge--neutral">@(Model.Course.EstimatedDurationHours?.ToString() ?? "N/A") hours</span>
                        <span class="badge badge--success">@(Model.Course.IsActive ? "Active" : "Inactive")</span>
                    </div>
                    <img src="@Model.Course.Image_URl" class="card__image" alt="@Model.Course.Title" style="height: 320px; border-radius: var(--border-radius-lg);" />
                </div>

                <div class="tabs mt-8" role="tablist">
                    <button class="tabs__button is-active" data-tab="overview" type="button">Overview</button>
                    <button class="tabs__button" data-tab="curriculum" type="button">Lessons</button>
                    <button class="tabs__button" data-tab="instructor" type="button">Instructor</button>
                    <button class="tabs__button" data-tab="reviews" type="button">Reviews</button>
                </div>

                <div class="tab-panel is-active" data-panel="overview">
                    <div class="card" style="padding: var(--spacing-8);">
                        <h3 class="heading-4">What you'll achieve</h3>
                        <ul class="text-small text-muted" style="line-height: 1.8;">
                            <li>Build a portfolio-ready project guided by mentors.</li>
                            <li>Practice with quizzes, labs, and real-world scenarios.</li>
                            <li>Earn a certificate to share with employers.</li>
                        </ul>
                        <h4 class="heading-5 mt-6">Requirements</h4>
                        <p class="text-muted">A growth mindset, 3 hours per week, and curiosity to explore new ideas.</p>
                    </div>
                </div>

                <div class="tab-panel" data-panel="curriculum">
                    <div class="accordion">
                        @if (Model.Lessons != null && Model.Lessons.Any())
                        {
                            @foreach (var lesson in Model.Lessons)
                            {
                                <div class="accordion__item">
                                    <div class="accordion__header" data-accordion>
                                        <div>
                                            <h4 class="heading-6">@lesson.Title</h4>
                                            <p class="text-small text-muted">Duration: @(lesson.DurationMinutes?.ToString() ?? "N/A") minutes</p>
                                        </div>
                                        <span class="badge badge--neutral">Lesson</span>
                                    </div>
                                    <div class="accordion__content">
                                        <p>Watch the lesson, complete the activity, and mark progress.</p>
                                        <a asp-page="/Lessons/Details" asp-route-id="@lesson.Id" class="btn btn--primary btn--sm">Open lesson</a>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="card" style="padding: var(--spacing-6);">
                                <p class="text-muted">No lessons have been added to this course yet.</p>
                            </div>
                        }
                    </div>
                </div>

                <div class="tab-panel" data-panel="instructor">
                    <div class="card" style="padding: var(--spacing-8);">
                        <h3 class="heading-4">Lead instructor</h3>
                        <p class="text-muted">Leila Ahmed · Product Strategy Lead</p>
                        <p class="text-small text-muted">10+ years building product teams and mentoring growth programs across EMEA and NA.</p>
                    </div>
                </div>

                <div class="tab-panel" data-panel="reviews">
                    <div class="card" style="padding: var(--spacing-8);">
                        <h3 class="heading-4">Learner reviews</h3>
                        <p class="text-muted">4.8 average rating · 2,140 reviews</p>
                        <div class="grid grid--cols-2 mt-6">
                            <div class="comment-box">
                                “Actionable lessons with great structure.”
                            </div>
                            <div class="comment-box">
                                “The assignments were challenging but rewarding.”
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <aside>
                <div class="card" style="padding: var(--spacing-6);">
                    <p class="text-small text-muted">Enrollment</p>
                    <h3 class="heading-4">Start this course today</h3>
                    <p class="text-muted">Includes 12 modules, downloadable resources, and certificate.</p>
                    <div class="progress mt-4">
                        <div class="progress__bar" style="width: 22%;"></div>
                    </div>
                    <p class="text-small text-muted mt-2">2 of 9 chapters completed</p>
                    <button class="btn btn--primary btn--full mt-4" type="button" id="enroll-button" data-course-id="@Model.Course.Id">Enroll and continue</button>
                    <a id="add-lesson-button" asp-page="/Lessons/Create" asp-route-courseId="@Model.Course.Id" class="btn btn--secondary btn--full mt-2" style="display: none;">Add new lesson</a>
                    <a asp-page="/Courses/Index" class="btn btn--ghost btn--full mt-2">Back to catalog</a>
                </div>
            </aside>
        </div>
    </div>
}
else
{
    <div class="card" style="padding: var(--spacing-8);">
        <p>Course not found.</p>
    </div>
}

@section Scripts {
    <script>
        const tabButtons = document.querySelectorAll('.tabs__button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        const accordions = document.querySelectorAll('[data-accordion]');
        const enrollButton = document.getElementById('enroll-button');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('is-active'));
                tabPanels.forEach(panel => panel.classList.remove('is-active'));
                button.classList.add('is-active');
                const panel = document.querySelector(`[data-panel="${button.dataset.tab}"]`);
                if (panel) panel.classList.add('is-active');
            });
        });

        accordions.forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('is-open');
            });
        });

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function parseJwt(token) {
            try {
                const payload = token.split('.')[1];
                const decoded = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
                return decoded;
            } catch (error) {
                return null;
            }
        }

        function getUserRoles(payload) {
            if (!payload) return [];
            const roles = payload.role || payload.roles || payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
            if (!roles) return [];
            return Array.isArray(roles) ? roles : [roles];
        }

        function checkAdminRole() {
            const token = getCookie('jwt_token');
            const addLessonButton = document.getElementById('add-lesson-button');
            if (!token || !addLessonButton) return;

            const payload = parseJwt(token);
            const roles = getUserRoles(payload);
            const isAdmin = roles.some(role => role?.toLowerCase() === 'admin');

            if (isAdmin) {
                addLessonButton.style.display = 'block';
            }
        }

        async function checkEnrollmentStatus() {
            const token = getCookie('jwt_token');
            if (!token || !enrollButton) return;

            const payload = parseJwt(token);
            const userId = payload?.nameid || payload?.sub;
            if (!userId) return;

            try {
                const response = await fetch('https://localhost:7228/api/enrollments', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) return;
                const enrollments = await response.json();
                const courseId = enrollButton.dataset.courseId;
                const isEnrolled = enrollments?.some(enrollment =>
                    enrollment.courseId?.toLowerCase() === courseId?.toLowerCase()
                    && enrollment.studentId?.toLowerCase() === userId?.toLowerCase());

                if (isEnrolled) {
                    enrollButton.disabled = true;
                    enrollButton.textContent = 'Enrolled';
                }
            } catch (error) {
                console.error('Enrollment status error:', error);
            }
        }

        if (enrollButton) {
            enrollButton.addEventListener('click', async () => {
                const token = getCookie('jwt_token');
                const courseId = enrollButton.dataset.courseId;

                if (!token) {
                    window.location.href = '/Account/Login';
                    return;
                }

                enrollButton.disabled = true;
                enrollButton.textContent = 'Enrolling...';

                try {
                    const response = await fetch(`https://localhost:7228/api/enrollments?courseId=${courseId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Enrollment failed');
                    }

                    enrollButton.textContent = 'Enrolled';
                    if (typeof showToast === 'function') {
                        showToast('You are now enrolled in this course.');
                    }
                } catch (error) {
                    console.error('Enrollment error:', error);
                    if (typeof showToast === 'function') {
                        showToast(error.message || 'Enrollment failed');
                    }
                    enrollButton.textContent = 'Enroll and continue';
                    enrollButton.disabled = false;
                }
            });
        }

        checkEnrollmentStatus();
        checkAdminRole();
    </script>
}
