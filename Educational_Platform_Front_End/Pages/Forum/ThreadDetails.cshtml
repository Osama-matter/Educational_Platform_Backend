@page "{id:guid}"
@model Educational_Platform_Front_End.Pages.Forum.ThreadDetailsModel
@{
    ViewData["Title"] = Model.Thread?.Title ?? "Thread Details";
}




<div class="thread-container">
    @if (Model.Thread != null)
    {
        <a asp-page="/Forum/Index" class="back-nav">
            <i class="lucide-arrow-left" style="width: 18px; height: 18px;"></i>
            Back to Forum
        </a>

        <div class="forum-layout">
            <div class="main-content-forum">
                @if (Model.Thread != null)
                {
                    <div class="post-layout">
                        <div class="post-voter">
                            <form method="post" asp-page-handler="VoteThread" asp-route-id="@Model.Thread.Id" asp-route-value="1">
                                <button type="submit" class="vote-btn @(Model.UserThreadVote == 1 ? "vote-btn--active" : "")" title="This question shows research effort; it is useful and clear">
                                    <i class="lucide-chevron-up"></i>
                                </button>
                            </form>
                            <span class="vote-count">@Model.Thread.VoteCount</span>
                            <form method="post" asp-page-handler="VoteThread" asp-route-id="@Model.Thread.Id" asp-route-value="-1">
                                <button type="submit" class="vote-btn @(Model.UserThreadVote == -1 ? "vote-btn--active" : "")" title="This question does not show any research effort; it is unclear or not useful">
                                    <i class="lucide-chevron-down"></i>
                                </button>
                            </form>
                            @if (User.Identity.IsAuthenticated)
                            {
                                <form method="post" asp-page-handler="@(Model.IsSubscribed ? "Unsubscribe" : "Subscribe")" class="mt-4">
                                    <button type="submit" class="btn @(Model.IsSubscribed ? "btn--secondary" : "btn--primary") btn--sm flex items-center gap-2" title="@(Model.IsSubscribed ? "Unsubscribe from this thread" : "Subscribe to this thread")">
                                        <i class="lucide-bell @(Model.IsSubscribed ? "fill-current" : "")" style="width: 16px; height: 16px;"></i>
                                        <span>@(Model.IsSubscribed ? "Subscribed" : "Subscribe")</span>
                                    </button>
                                </form>
                            }
                        </div>
                        <div class="post-body">
                            <h1 style="font-size: 27px; font-weight: 400; margin: 0 0 16px 0; color: #3b4045; line-height: 1.35;">@Model.Thread.Title</h1>
                            <div class="post-text">
                                @Model.Thread.Description
                            </div>
                            <div class="post-signature-container">
                                <div class="post-actions">
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        <button type="button" class="btn--link text-muted" onclick="toggleReplyForm('@Model.Thread.Id')">reply</button>
                                        @if (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.Thread.UserId.ToString())
                                        {
                                            <button type="button" class="btn--link text-muted" onclick="toggleEditForm('@Model.Thread.Id')">edit</button>
                                            <form method="post" asp-page-handler="DeletePost" asp-route-postId="@Model.Thread.Id" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this?');">
                                                <button type="submit" class="btn--link text-danger">delete</button>
                                            </form>
                                        }
                                    }
                                </div>
                                <div class="post-signature">
                                    <div class="signature-date">asked @Model.Thread.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")</div>
                                    <div class="signature-user">
                                        <div class="avatar signature-avatar">@(Model.Thread.UserName?[0].ToString().ToUpper() ?? "A")</div>
                                        <span class="text-primary">@(Model.Thread.UserName ?? "Anonymous")</span>
                                    </div>
                                </div>
                            </div>

                            @if (User.Identity.IsAuthenticated)
                            {
                                <div id="reply-form-@Model.Thread.Id" class="reply-form-nested mt-4" style="display: none;">
                                    <form method="post" asp-page-handler="PostReply">
                                        <input type="hidden" name="ParentPostId" value="" />
                                        <textarea name="ReplyContent" class="reply-textarea" rows="3" placeholder="Add an answer..." required></textarea>
                                        <div class="mt-2">
                                            <button type="submit" class="btn btn--primary btn--sm">Post Answer</button>
                                            <button type="button" class="btn--link text-muted ml-2" onclick="toggleReplyForm('@Model.Thread.Id')">cancel</button>
                                        </div>
                                    </form>
                                </div>

                                @if (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.Thread.UserId.ToString())
                                {
                                    <div id="edit-form-@Model.Thread.Id" class="reply-form-nested mt-4" style="display: none;">
                                        <form method="post" asp-page-handler="EditPost">
                                            <input type="hidden" name="postId" value="@Model.Thread.Id" />
                                            <textarea name="content" class="reply-textarea" rows="3" required>@Model.Thread.Description</textarea>
                                            <div class="mt-2">
                                                <button type="submit" class="btn btn--primary btn--sm">Save Changes</button>
                                                <button type="button" class="btn--link text-muted ml-2" onclick="toggleEditForm('@Model.Thread.Id')">cancel</button>
                                            </div>
                                        </form>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <div class="answers-header mt-8 mb-6">
                        <h2>@(Model.Posts?.Count() ?? 0) Answers</h2>
                    </div>

                    @if (Model.Posts != null && Model.Posts.Any())
                    {
                        foreach (var postVm in Model.Posts)
                        {
                            await RenderPost(postVm);
                        }
                    }

            @functions {
                async Task RenderPost(ThreadDetailsModel.ForumPostViewModel postVm, int depth = 0)
                {
                    var post = postVm.Post;
                    var marginLeft = depth * 20;
                    <div class="post-layout border-bottom pb-6" style="margin-left: @(marginLeft)px; @(depth > 0 ? "border-left: 2px solid #e3e6e8; padding-left: 16px; margin-top: 10px;" : "")">
                        <div class="post-voter">
                            <form method="post" asp-page-handler="Vote" asp-route-postId="@post.Id" asp-route-value="1">
                                <button type="submit" class="vote-btn @(postVm.UserVote == 1 ? "vote-btn--active" : "")" title="This answer is useful">
                                    <i class="lucide-chevron-up"></i>
                                </button>
                            </form>
                            <span class="vote-count">@post.VoteCount</span>
                            <form method="post" asp-page-handler="Vote" asp-route-postId="@post.Id" asp-route-value="-1">
                                <button type="submit" class="vote-btn @(postVm.UserVote == -1 ? "vote-btn--active" : "")" title="This answer is not useful">
                                    <i class="lucide-chevron-down"></i>
                                </button>
                            </form>
                            @if (post.IsHelpful)
                            {
                                <div class="text-success mt-2" title="The question owner accepted this as the best answer">
                                    <i class="lucide-check" style="width: 32px; height: 32px;"></i>
                                </div>
                            }
                        </div>
                        <div class="post-body">
                            <div class="post-text">
                                @Html.Raw(post.Content)
                            </div>
                            <div class="post-signature-container">
                                <div class="post-actions">
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        <button type="button" class="btn--link text-muted" onclick="toggleReplyForm('@post.Id')">reply</button>
                                        @if (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == post.UserId.ToString())
                                        {
                                            <button type="button" class="btn--link text-muted" onclick="toggleEditForm('@post.Id')">edit</button>
                                            <form method="post" asp-page-handler="DeletePost" asp-route-postId="@post.Id" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this?');">
                                                <button type="submit" class="btn--link text-danger">delete</button>
                                            </form>
                                        }
                                    }
                                </div>
                                <div class="post-signature">
                                    <div class="signature-date">@(post.ParentPostId == null ? "answered" : "commented") @post.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")</div>
                                    <div class="signature-user">
                                        <div class="avatar signature-avatar">@(post.UserName?[0].ToString().ToUpper() ?? "A")</div>
                                        <span class="text-primary">@(post.UserName ?? "Anonymous")</span>
                                    </div>
                                </div>
                            </div>

                            @if (User.Identity.IsAuthenticated)
                            {
                                <div id="reply-form-@post.Id" class="reply-form-nested mt-4" style="display: none;">
                                    <form method="post" asp-page-handler="PostReply">
                                        <input type="hidden" name="ParentPostId" value="@post.Id" />
                                        <textarea name="ReplyContent" class="reply-textarea" rows="3" placeholder="Add a comment..." required></textarea>
                                        <div class="mt-2">
                                            <button type="submit" class="btn btn--primary btn--sm">Post Comment</button>
                                            <button type="button" class="btn--link text-muted ml-2" onclick="toggleReplyForm('@post.Id')">cancel</button>
                                        </div>
                                    </form>
                                </div>

                                @if (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == post.UserId.ToString())
                                {
                                    <div id="edit-form-@post.Id" class="reply-form-nested mt-4" style="display: none;">
                                        <form method="post" asp-page-handler="EditPost">
                                            <input type="hidden" name="postId" value="@post.Id" />
                                            <textarea name="content" class="reply-textarea" rows="3" required>@post.Content</textarea>
                                            <div class="mt-2">
                                                <button type="submit" class="btn btn--primary btn--sm">Save Changes</button>
                                                <button type="button" class="btn--link text-muted ml-2" onclick="toggleEditForm('@post.Id')">cancel</button>
                                            </div>
                                        </form>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    @if (postVm.Replies != null && postVm.Replies.Any())
                    {
                        <div class="replies-container">
                            @foreach (var reply in postVm.Replies)
                            {
                                await RenderPost(reply, depth + 1);
                            }
                        </div>
                    }
                }
            }

            @if (User.Identity.IsAuthenticated)
            {
                <div class="reply-section mt-12">
                    <h3>Your Answer</h3>
                    <form method="post" asp-page-handler="PostReply">
                        <div class="reply-form-group">
                            <textarea name="ReplyContent" class="reply-textarea" rows="10" required></textarea>
                        </div>
                        <button type="submit" class="btn btn--primary mt-4">Post Your Answer</button>
                    </form>
                </div>
            }
            else
            {
                <div class="login-prompt mt-8">
                    <p>Join the community to answer this question. <a asp-page="/Account/Login" class="text-primary">Log in</a> to post your answer.</p>
                </div>
            }
                        }
        </div>
    </div>
        }
</div>

@section Scripts {
    <script>
        function toggleReplyForm(postId) {
            const form = document.getElementById('reply-form-' + postId);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }

        function toggleEditForm(postId) {
            const form = document.getElementById('edit-form-' + postId);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
}