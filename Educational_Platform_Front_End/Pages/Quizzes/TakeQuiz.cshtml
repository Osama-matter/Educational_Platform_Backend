@page "/quiz/{id:guid}"
@model Educational_Platform_Front_End.Pages.Quizzes.TakeQuizModel

@{ 
    ViewData["Title"] = Model.QuizAttempt?.QuizTitle ?? "Take Quiz";
}

<div class="container py-5">
    @if (Model.QuizAttempt != null)
    {
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Quiz Header -->
                <div class="card border-0 shadow-sm rounded-xl mb-4 overflow-hidden">
                    <div class="card-body p-4 bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 font-weight-bold mb-1">@Model.QuizAttempt.QuizTitle</h1>
                                <p class="mb-0 opacity-75">Answer all questions to complete the assessment</p>
                            </div>
                            <div class="text-right">
                                <div id="quiz-timer" class="h2 font-weight-bold mb-0" data-time-limit="@(Model.QuizAttempt.TotalTimeMinutes * 60)">
                                    --:--
                                </div>
                                <small class="text-white-50 uppercase tracking-wider">Remaining</small>
                            </div>
                        </div>
                    </div>
                    <div class="progress rounded-0" style="height: 6px;">
                        <div id="quiz-progress-bar" class="progress-bar bg-accent" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <form id="quizForm" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-4"></div>

                    @for (int i = 0; i < Model.QuizAttempt.Questions.Count; i++)
                    {
                        var question = Model.QuizAttempt.Questions[i];
                        <input type="hidden" name="QuestionIds[@i]" value="@question.Id" />
                        <div class="card border-0 shadow-sm rounded-xl mb-4 question-card @(i == 0 ? "" : "d-none")" data-question-index="@i">
                            <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                                <span class="badge badge-soft-primary px-3 py-2 rounded-pill">Question @(i + 1) of @Model.QuizAttempt.Questions.Count</span>
                                <span class="text-muted font-weight-bold"><i class="lucide-award mr-1"></i> @question.Score Points</span>
                            </div>
                            <div class="card-body p-4">
                                <h4 class="font-weight-bold text-dark mb-4">@question.Content</h4>
                                <div class="quiz-options-grid">
                                    @foreach (var option in question.Options)
                                    {
                                        <label class="quiz-option-label mb-3">
                                            <input type="radio" 
                                                   name="AnswerIds[@i]" 
                                                   value="@option.Id" 
                                                   class="quiz-option-input d-none" 
                                                   data-question-id="@question.Id"
                                                   data-index="@i"
                                                   @(Model.AnswerIds.Count > i && Model.AnswerIds[i] == option.Id ? "checked" : "") />
                                            <div class="quiz-option-card p-3 border rounded-lg transition-all d-flex align-items-center">
                                                <div class="quiz-option-indicator mr-3 d-flex align-items-center justify-content-center border rounded-circle" style="width: 24px; height: 24px;">
                                                    <div class="inner-dot rounded-circle bg-primary d-none" style="width: 12px; height: 12px;"></div>
                                                </div>
                                                <span class="text-dark">@option.Text</span>
                                            </div>
                                        </label>
                                    }
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 pb-4 px-4 d-flex justify-content-between">
                                <button type="button" class="btn btn-light px-4 rounded-pill prev-btn @(i == 0 ? "invisible" : "")" onclick="showQuestion(@(i - 1))">
                                    <i class="lucide-arrow-left mr-2"></i> Previous
                                </button>
                                
                                @if (i == Model.QuizAttempt.Questions.Count - 1)
                                {
                                    <button type="button" class="btn btn-success px-5 rounded-pill font-weight-bold" onclick="confirmSubmit()">
                                        Finish Assessment <i class="lucide-check-circle ml-2"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-primary px-5 rounded-pill font-weight-bold next-btn" onclick="showQuestion(@(i + 1))">
                                        Next Question <i class="lucide-arrow-right ml-2"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </form>
                </div>
            </div>
    
    }
    else
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading quiz...</span>
            </div>
            <p class="mt-3">Preparing your quiz attempt...</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @Model.ErrorMessage
        </div>
    }
</div>

@section Scripts {
    <script>
        let timeRemaining = parseInt(document.getElementById('quiz-timer').dataset.timeLimit);
        const timerElement = document.getElementById('quiz-timer');
        const totalQuestions = @(Model.QuizAttempt?.Questions.Count ?? 0);
        let quizSubmitted = false;

        // Load saved answers from localStorage
        const attemptId = "@Model.Id";
        const savedAnswersKey = `quiz_answers_${attemptId}`;

        function initQuiz() {
            const savedAnswers = JSON.parse(localStorage.getItem(savedAnswersKey) || "{}");
            Object.entries(savedAnswers).forEach(([qId, oId]) => {
                const radio = document.querySelector(`input[value="${oId}"][data-question-id="${qId}"]`);
                if (radio) radio.checked = true;
            });

            // Timer interval
            const interval = setInterval(() => {
                if (quizSubmitted) {
                    clearInterval(interval);
                    return;
                }

                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    clearInterval(interval);
                    autoSubmit();
                }
            }, 1000);

            // Save answers on change
            document.querySelectorAll('.quiz-option').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const savedAnswers = JSON.parse(localStorage.getItem(savedAnswersKey) || "{}");
                    savedAnswers[e.target.dataset.questionId] = e.target.value;
                    localStorage.setItem(savedAnswersKey, JSON.stringify(savedAnswers));
                });
            });

            // Prevent accidental refresh
            window.onbeforeunload = function() {
                if (!quizSubmitted) {
                    return "You have a quiz in progress. Are you sure you want to leave?";
                }
            };
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerElement.textContent = `Time Remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining < 60) {
                timerElement.classList.replace('bg-primary', 'bg-danger');
            }
        }

        function showQuestion(index) {
            document.querySelectorAll('.question-card').forEach((card, i) => {
                if (i === index) card.classList.remove('d-none');
                else card.classList.add('d-none');
            });
        }

        function confirmSubmit() {
            const totalAnswered = document.querySelectorAll('.quiz-option:checked').length;
            const warning = document.getElementById('unanswered-warning');
            
            if (totalAnswered < totalQuestions) {
                warning.classList.remove('d-none');
            } else {
                warning.classList.add('d-none');
            }

            const modal = new bootstrap.Modal(document.getElementById('submitModal'));
            modal.show();
        }

        function autoSubmit() {
            quizSubmitted = true;
            localStorage.removeItem(savedAnswersKey);
            alert("Time's up! Your quiz is being submitted automatically.");
            document.getElementById('quizForm').submit();
        }

        document.getElementById('quizForm')?.addEventListener('submit', () => {
            quizSubmitted = true;
            localStorage.removeItem(savedAnswersKey);
        });

        if (totalQuestions > 0) {
            initQuiz();
            updateTimerDisplay();
        }
    </script>
}
