@page "/quiz/{id:guid}"
@model Educational_Platform_Front_End.Pages.Quizzes.TakeQuizModel

@{ 
    ViewData["Title"] = Model.QuizAttempt?.QuizTitle ?? "Take Quiz";
}

<div class="container mt-4">
    @if (Model.QuizAttempt != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>@Model.QuizAttempt.QuizTitle</h1>
            <div id="quiz-timer" class="badge bg-primary fs-4" data-time-limit="@(Model.QuizAttempt.TotalTimeMinutes * 60)">
                Time Remaining: --:--
            </div>
        </div>

        <form id="quizForm" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            @for (int i = 0; i < Model.QuizAttempt.Questions.Count; i++)
            {
                var question = Model.QuizAttempt.Questions[i];
                <input type="hidden" name="QuestionIds[@i]" value="@question.Id" />
                <div class="card my-4 question-card @(i == 0 ? "" : "d-none")" data-question-index="@i">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Question @(i + 1) of @Model.QuizAttempt.Questions.Count</h5>
                        <span class="badge bg-secondary">@question.Score Points</span>
                    </div>
                    <div class="card-body">
                        <p class="fs-5 mb-4">@question.Content</p>
                        <div class="list-group">
                            @foreach (var option in question.Options)
                            {
                                <label class="list-group-item list-group-item-action mb-2 rounded border">
                                    <input type="radio" 
                                           name="AnswerIds[@i]" 
                                           value="@option.Id" 
                                           class="form-check-input me-3 quiz-option" 
                                           data-question-id="@question.Id"
                                           data-index="@i"
                                           @(Model.AnswerIds.Count > i && Model.AnswerIds[i] == option.Id ? "checked" : "") />
                                    @option.Text
                                </label>
                            }
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary prev-btn @(i == 0 ? "invisible" : "")" onclick="showQuestion(@(i - 1))">Previous</button>
                        
                        @if (i == Model.QuizAttempt.Questions.Count - 1)
                        {
                            <button type="button" class="btn btn-success" onclick="confirmSubmit()">Finish Quiz</button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-primary next-btn" onclick="showQuestion(@(i + 1))">Next Question</button>
                        }
                    </div>
                </div>
            }
        </form>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Finish Quiz?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to submit your answers? You cannot change them after submission.
                        <div id="unanswered-warning" class="text-danger mt-2 d-none">
                            <strong>Warning:</strong> You have unanswered questions!
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                        <button type="button" class="btn btn-success" onclick="document.getElementById('quizForm').submit()">Submit Now</button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading quiz...</span>
            </div>
            <p class="mt-3">Preparing your quiz attempt...</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @Model.ErrorMessage
        </div>
    }
</div>

@section Scripts {
    <script>
        let timeRemaining = parseInt(document.getElementById('quiz-timer').dataset.timeLimit);
        const timerElement = document.getElementById('quiz-timer');
        const totalQuestions = @(Model.QuizAttempt?.Questions.Count ?? 0);
        let quizSubmitted = false;

        // Load saved answers from localStorage
        const attemptId = "@Model.Id";
        const savedAnswersKey = `quiz_answers_${attemptId}`;

        function initQuiz() {
            const savedAnswers = JSON.parse(localStorage.getItem(savedAnswersKey) || "{}");
            Object.entries(savedAnswers).forEach(([qId, oId]) => {
                const radio = document.querySelector(`input[value="${oId}"][data-question-id="${qId}"]`);
                if (radio) radio.checked = true;
            });

            // Timer interval
            const interval = setInterval(() => {
                if (quizSubmitted) {
                    clearInterval(interval);
                    return;
                }

                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    clearInterval(interval);
                    autoSubmit();
                }
            }, 1000);

            // Save answers on change
            document.querySelectorAll('.quiz-option').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const savedAnswers = JSON.parse(localStorage.getItem(savedAnswersKey) || "{}");
                    savedAnswers[e.target.dataset.questionId] = e.target.value;
                    localStorage.setItem(savedAnswersKey, JSON.stringify(savedAnswers));
                });
            });

            // Prevent accidental refresh
            window.onbeforeunload = function() {
                if (!quizSubmitted) {
                    return "You have a quiz in progress. Are you sure you want to leave?";
                }
            };
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerElement.textContent = `Time Remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining < 60) {
                timerElement.classList.replace('bg-primary', 'bg-danger');
            }
        }

        function showQuestion(index) {
            document.querySelectorAll('.question-card').forEach((card, i) => {
                if (i === index) card.classList.remove('d-none');
                else card.classList.add('d-none');
            });
        }

        function confirmSubmit() {
            const totalAnswered = document.querySelectorAll('.quiz-option:checked').length;
            const warning = document.getElementById('unanswered-warning');
            
            if (totalAnswered < totalQuestions) {
                warning.classList.remove('d-none');
            } else {
                warning.classList.add('d-none');
            }

            const modal = new bootstrap.Modal(document.getElementById('submitModal'));
            modal.show();
        }

        function autoSubmit() {
            quizSubmitted = true;
            localStorage.removeItem(savedAnswersKey);
            alert("Time's up! Your quiz is being submitted automatically.");
            document.getElementById('quizForm').submit();
        }

        document.getElementById('quizForm')?.addEventListener('submit', () => {
            quizSubmitted = true;
            localStorage.removeItem(savedAnswersKey);
        });

        if (totalQuestions > 0) {
            initQuiz();
            updateTimerDisplay();
        }
    </script>
}
