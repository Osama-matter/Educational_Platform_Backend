@page "{id:guid}"
@model Educational_Platform_Front_End.Pages.Lessons.DetailsModel
@{
    ViewData["Title"] = Model.Lesson?.Title ?? "Lesson Details";
}

@section Scripts {
    <script>
        function extractYouTubeId(text) {
            if (!text) return null;
            const regex = /(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([\w-]{11})/i;
            const match = text.match(regex);
            return match ? match[1] : null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const content = document.getElementById('lesson-content');
            const videoWrapper = document.getElementById('lesson-video');
            const iframe = document.getElementById('youtube-embed');
            if (!content || !videoWrapper || !iframe) return;

            const videoId = extractYouTubeId(content.textContent);
            if (!videoId) return;

            iframe.src = `https://www.youtube.com/embed/${videoId}`;
            videoWrapper.style.display = 'grid';
        });
    </script>
}

@if (Model.Lesson != null)
{
    <div class="container pt-8 pb-8">
        <div class="lesson-layout">
            <aside class="lesson-sidebar">
                <p class="text-small text-muted">Course module</p>
                <h2 class="heading-5">Lesson navigation</h2>
                <div class="mt-4">
                    <p class="text-small text-muted">Current lesson</p>
                    <p class="font-medium">@Model.Lesson.Title</p>
                </div>
                <div class="mt-6">
                    <form method="post" asp-page-handler="Complete" asp-route-id="@Model.Lesson.Id">
                        <button class="btn btn--primary btn--full" type="submit">Mark complete</button>
                    </form>
                    @if (TempData["StatusMessage"] != null)
                    {
                        <p class="text-small text-muted mt-2">@TempData["StatusMessage"]</p>
                    }
                    <a asp-page="/Lessons/Index" asp-route-courseId="@Model.Lesson.CourseId" class="btn btn--secondary btn--full mt-2">Back to lessons</a>
                </div>
                <div class="mt-6">
                    <p class="text-small text-muted">Duration</p>
                    <p class="font-medium">@(Model.Lesson.DurationMinutes?.ToString() ?? "N/A") minutes</p>
                </div>
            </aside>

            <section>
                <div class="lesson-player">
                    <h1 class="heading-4">@Model.Lesson.Title</h1>
                    <div class="lesson-player mt-4" id="lesson-video" style="display: none;">
                        <iframe id="youtube-embed" width="100%" height="360" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                </div>

                <div class="text-muted" id="lesson-content" style="display: none;">@Html.Raw(Model.Lesson.Content)</div>

                <div class="resource-grid mt-6">
                    <div class="resource-card">
                        <p class="font-medium">Slides</p>
                        <p class="text-small text-muted">Product strategy deck.pdf</p>
                    </div>
                    <div class="resource-card">
                        <p class="font-medium">Worksheet</p>
                        <p class="text-small text-muted">Discovery checklist.docx</p>
                    </div>
                    <div class="resource-card">
                        <p class="font-medium">Template</p>
                        <p class="text-small text-muted">Go-to-market canvas.fig</p>
                    </div>
                </div>

                <div class="quiz-card mt-6">
                    <h3 class="heading-5">Lesson Quizzes</h3>
                    @if (Model.Lesson.Quizzes != null && Model.Lesson.Quizzes.Any())
                    {
                        <div class="flex flex-col gap-3 mt-4">
                            @foreach (var quiz in Model.Lesson.Quizzes)
                            {
                                <div class="card p-4 flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="font-medium mb-0">@quiz.Title</h6>
                                        <p class="text-small text-muted mb-0">Duration: @quiz.DurationMinutes mins</p>
                                    </div>
                                    <form method="post" asp-page="/Quizzes/AvailableQuizzes" asp-page-handler="StartAttempt" asp-route-quizId="@quiz.Id">
                                        <button type="submit" class="btn btn--secondary btn--sm rounded-pill">Start Quiz</button>
                                    </form>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-small text-muted mt-4">No quizzes available for this lesson.</p>
                    }
                </div>

                <div class="card mt-6" style="padding: var(--spacing-6);">
                    <h3 class="heading-5">Discussion</h3>
                    <div class="comment-box mt-4">
                        “Loved the real-world example about stakeholder alignment.”
                    </div>
                    <div class="comment-box mt-4">
                        “Can you share more about tools for rapid prototyping?”
                    </div>
                    <div class="mt-4">
                        <textarea class="form__textarea" rows="4" placeholder="Add a comment"></textarea>
                        <button class="btn btn--secondary mt-2" type="button">Post comment</button>
                    </div>
                </div>
            </section>
        </div>
    </div>
}
else
{
    <div class="card" style="padding: var(--spacing-8);">
        <p>Lesson not found.</p>
    </div>
}
