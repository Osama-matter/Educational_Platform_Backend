@page
@model Educational_Platform_Front_End.Pages.Dashboard.AdminDashboardModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/enterprise-design-system.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />
}

<div class="admin-layout" id="adminLayout">
    <aside class="admin-layout__sidebar">
        <nav class="admin-sidebar">
            <div class="admin-sidebar__brand">
                <div class="admin-sidebar__logo">E</div>
                <span class="admin-sidebar__brand-text">EduAdmin</span>
            </div>

            <div class="admin-sidebar__nav">
                <div class="admin-sidebar__section">
                    <div class="admin-sidebar__section-title">Overview</div>
                    <a href="#dashboard" class="admin-sidebar__link admin-sidebar__link--active">
                        <i data-lucide="layout-dashboard" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Dashboard</span>
                    </a>
                    <a href="#analytics" class="admin-sidebar__link">
                        <i data-lucide="bar-chart-3" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Analytics</span>
                    </a>
                </div>

                <div class="admin-sidebar__section">
                    <div class="admin-sidebar__section-title">Content</div>
                    <a asp-page="/Dashboard/CourseManagement" class="admin-sidebar__link">
                        <i data-lucide="book-open" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Courses</span>
                    </a>
                    <a asp-page="/Admin/Lessons/Index" class="admin-sidebar__link">
                        <i data-lucide="video" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Lessons</span>
                    </a>
                </div>

                <div class="admin-sidebar__section">
                    <div class="admin-sidebar__section-title">Users</div>
                    <a asp-page="/Dashboard/Index" class="admin-sidebar__link">
                        <i data-lucide="users" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Enrollments</span>
                    </a>
                    <a asp-page="/Dashboard/Index" class="admin-sidebar__link">
                        <i data-lucide="trending-up" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Progress Tracking</span>
                    </a>
                    <a asp-page="/Dashboard/Index" class="admin-sidebar__link">
                        <i data-lucide="graduation-cap" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Students</span>
                    </a>
                </div>

                <div class="admin-sidebar__section">
                    <div class="admin-sidebar__section-title">System</div>
                    <a href="#settings" class="admin-sidebar__link">
                        <i data-lucide="settings" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Settings</span>
                    </a>
                    <a href="#reports" class="admin-sidebar__link">
                        <i data-lucide="file-text" class="admin-sidebar__link-icon"></i>
                        <span class="admin-sidebar__link-text">Reports</span>
                    </a>
                </div>
            </div>
        </nav>
    </aside>

    <header class="admin-layout__header">
        <div class="admin-header">
            <div class="admin-header__left">
                <button class="admin-header__toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <i data-lucide="menu" style="width: 20px; height: 20px;"></i>
                </button>

                <div class="admin-header__search">
                    <i data-lucide="search" class="admin-header__search-icon" style="width: 18px; height: 18px;"></i>
                    <input type="search" class="admin-header__search-input" placeholder="Search courses, students, lessons..." aria-label="Global search">
                </div>
            </div>

            <div class="admin-header__right">
                <button class="admin-header__toggle" id="themeToggle" aria-label="Toggle theme">
                    <i data-lucide="moon" style="width: 20px; height: 20px;"></i>
                </button>
                <button class="admin-header__toggle" aria-label="Notifications">
                    <i data-lucide="bell" style="width: 20px; height: 20px;"></i>
                </button>
                <div class="admin-header__profile">
                    <div class="admin-header__avatar">AD</div>
                    <div class="admin-header__user-info">
                        <span class="admin-header__user-name">Admin</span>
                        <span class="admin-header__user-role">Platform Admin</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="admin-layout__main">
        <div class="flex justify-between items-center" style="margin-bottom: var(--space-8);">
            <div>
                <h1 style="font-family: var(--font-display); font-size: var(--font-size-4xl); font-weight: var(--font-weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                    Dashboard Overview
                </h1>
                <p style="font-size: var(--font-size-base); color: var(--text-secondary);">
                    Welcome back! Here's what's happening with your platform today.
                </p>
            </div>
            <a asp-page="/Account/RegisterAdmin" class="btn btn--primary">
                <i data-lucide="plus" class="btn__icon"></i>
                Add Admin
            </a>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card stat-card--primary">
                <div class="stat-card__header">
                    <div class="stat-card__icon">
                        <i data-lucide="book-open" style="width: 24px; height: 24px;"></i>
                    </div>
                </div>
                <div class="stat-card__value" id="admin-total-courses">0</div>
                <div class="stat-card__label">Total Courses</div>
                <div class="stat-card__trend stat-card__trend--positive">
                    <i data-lucide="trending-up" class="stat-card__trend-icon"></i>
                    <span>Updated from live data</span>
                </div>
            </div>

            <div class="stat-card stat-card--success">
                <div class="stat-card__header">
                    <div class="stat-card__icon" style="--icon-bg: var(--color-success-50); --icon-color: var(--color-success-600);">
                        <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                    </div>
                </div>
                <div class="stat-card__value" id="admin-active-students">0</div>
                <div class="stat-card__label">Active Students</div>
                <div class="stat-card__trend stat-card__trend--positive">
                    <i data-lucide="trending-up" class="stat-card__trend-icon"></i>
                    <span>Based on enrollments</span>
                </div>
            </div>

            <div class="stat-card stat-card--info">
                <div class="stat-card__header">
                    <div class="stat-card__icon" style="--icon-bg: var(--color-info-50); --icon-color: var(--color-info-600);">
                        <i data-lucide="user-check" style="width: 24px; height: 24px;"></i>
                    </div>
                </div>
                <div class="stat-card__value" id="admin-active-enrollments">0</div>
                <div class="stat-card__label">Active Enrollments</div>
                <div class="stat-card__trend stat-card__trend--positive">
                    <i data-lucide="trending-up" class="stat-card__trend-icon"></i>
                    <span>Tracking course engagement</span>
                </div>
            </div>

            <div class="stat-card stat-card--warning">
                <div class="stat-card__header">
                    <div class="stat-card__icon" style="--icon-bg: var(--color-warning-50); --icon-color: var(--color-warning-600);">
                        <i data-lucide="award" style="width: 24px; height: 24px;"></i>
                    </div>
                </div>
                <div class="stat-card__value" id="admin-completion-rate">0%</div>
                <div class="stat-card__label">Completion Rate</div>
                <div class="stat-card__trend stat-card__trend--negative">
                    <i data-lucide="trending-down" class="stat-card__trend-icon"></i>
                    <span>Based on lesson progress</span>
                </div>
            </div>
        </div>

        <div class="activity-log">
            <div class="activity-log__header">
                <h2 class="activity-log__title">Admin Activity</h2>
            </div>
            <div class="activity-log__list" id="admin-activity-log">
                <div class="activity-log__item">
                    <div class="activity-log__icon">
                        <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                    </div>
                    <div class="activity-log__content">
                        <div class="activity-log__message">Loading admin insights...</div>
                        <div class="activity-log__time">Just now</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="course-management-section mt-8">
            <h2 class="heading-3 mb-4">Course Management</h2>
            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Course Title</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Courses != null && Model.Courses.Any())
                        {
                            foreach (var course in Model.Courses)
                            {
                                <tr>
                                    <td>@course.Title</td>
                                    <td>
                                        <a asp-page="/Lessons/Index" asp-route-courseId="@course.Id" class="btn btn--secondary btn--sm">View Lessons</a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2">No courses available.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

@section Scripts {
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function parseJwt(token) {
            try {
                const payload = token.split('.')[1];
                return JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
            } catch (error) {
                return null;
            }
        }

        function getUserRoles(payload) {
            if (!payload) return [];
            const roles = payload.role || payload.roles || payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
            if (!roles) return [];
            return Array.isArray(roles) ? roles : [roles];
        }

        function requireAdmin() {
            const token = getCookie('jwt_token');
            if (!token) {
                window.location.href = '/Account/Login';
                return false;
            }
            const payload = parseJwt(token);
            const roles = getUserRoles(payload);
            const isAdmin = roles.some(role => role?.toLowerCase() === 'admin');
            if (!isAdmin) {
                window.location.href = '/Dashboard/Index';
                return false;
            }
            return true;
        }

        async function loadAdminStats() {
            const token = getCookie('jwt_token');
            if (!token) return;

            try {
                const [coursesRes, enrollmentsRes, progressRes] = await Promise.all([
                    fetch('https://localhost:7228/api/courses', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('https://localhost:7228/api/enrollments', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('https://localhost:7228/api/progress', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const courses = coursesRes.ok ? await coursesRes.json() : [];
                const enrollments = enrollmentsRes.ok ? await enrollmentsRes.json() : [];
                const progress = progressRes.ok ? await progressRes.json() : [];

                const activeEnrollments = enrollments.filter(item => item.isActive);
                const studentIds = new Set(activeEnrollments.map(item => item.studentId));
                const completedCount = progress.filter(item => item.isCompleted).length;
                const completionRate = progress.length ? Math.round((completedCount / progress.length) * 100) : 0;

                document.getElementById('admin-total-courses').textContent = courses.length.toString();
                document.getElementById('admin-active-enrollments').textContent = activeEnrollments.length.toString();
                document.getElementById('admin-active-students').textContent = studentIds.size.toString();
                document.getElementById('admin-completion-rate').textContent = `${completionRate}%`;
            } catch (error) {
                console.error('Admin stats error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAdmin()) return;
            lucide.createIcons();

            const sidebarToggle = document.getElementById('sidebarToggle');
            const adminLayout = document.getElementById('adminLayout');
            if (sidebarToggle && adminLayout) {
                sidebarToggle.addEventListener('click', () => {
                    adminLayout.classList.toggle('admin-layout--sidebar-collapsed');
                });
            }

            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const currentTheme = html.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', newTheme);
                    const icon = themeToggle.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-lucide', newTheme === 'light' ? 'moon' : 'sun');
                        lucide.createIcons();
                    }
                });
            }

            loadAdminStats();
        });
    </script>
}
